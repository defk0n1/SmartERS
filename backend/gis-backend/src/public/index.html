<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>SmartERS Ambulance Simulation</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Avenir Next', Arial, sans-serif;
        }

        arcgis-map {
            height: 100%;
            width: 100%;
        }

        #controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 99;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #startBtn {
            background: #0079c1;
            color: white;
        }

        #startBtn:hover {
            background: #005a87;
        }

        #stopBtn {
            background: #d83020;
            color: white;
        }

        #stopBtn:hover {
            background: #a82315;
        }

        #clearBtn {
            background: #f3f3f3;
            color: #323232;
            border: 1px solid #ccc;
        }

        #clearBtn:hover {
            background: #e0e0e0;
        }

        #status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 99;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .connected {
            background-color: #00c851;
        }

        .disconnected {
            background-color: #ff4444;
        }

        h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #323232;
        }
    </style>

    <!-- 1ï¸âƒ£ Load Socket.IO first (UMD global) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- 2ï¸âƒ£ Load ArcGIS Maps SDK base (AMD/Dojo) -->
    <script src="https://js.arcgis.com/4.34/"></script>

    <!-- 3ï¸âƒ£ Only load map-components if you actually need them (optional) -->
    <script type="module" src="https://js.arcgis.com/4.34/map-components/"></script>

    <!-- 4ï¸âƒ£ Load Calcite components as module -->
    <script type="module" src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"></script>
</head>

<body>
    <div id="controls">
        <h3>ðŸš‘ SmartERS Control</h3>
        <button id="startBtn">Start Simulation</button>
        <button id="stopBtn">Stop Simulation</button>
        <button id="clearBtn">Clear Map</button>
    </div>

    <div id="status">
        <span class="status-indicator disconnected" id="statusDot"></span>
        <span id="statusText">Connecting to server...</span>
    </div>

    <arcgis-map basemap="streets-navigation-vector" center="10.16579,36.81897" zoom="13">
        <arcgis-zoom position="top-left"></arcgis-zoom>
    </arcgis-map>

<script>
  const socket = io();
  let view, Graphic, Point, Polyline, GraphicsLayer;
  let ambulanceLayer, routeLayer;
  let animationHandles = [];

  socket.on("connect", () => updateStatus(true, "Connected to server"));
  socket.on("disconnect", () => updateStatus(false, "Disconnected"));

  function updateStatus(connected, text) {
    statusDot.className =
      "status-indicator " + (connected ? "connected" : "disconnected");
    statusText.textContent = text;
  }

  const mapElement = document.querySelector("arcgis-map");

  mapElement.addEventListener("arcgisViewReadyChange", () => {
    view = mapElement.view;

    require([
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/geometry/Polyline",
      "esri/layers/GraphicsLayer"
    ], (G, P, PL, GL) => {
      Graphic = G;
      Point = P;
      Polyline = PL;
      GraphicsLayer = GL;

      ambulanceLayer = new GraphicsLayer();
      routeLayer = new GraphicsLayer();

      view.map.addMany([routeLayer, ambulanceLayer]);

      console.log("ðŸ—ºï¸ Simulation map ready");
    });
  });

  function clearMap() {
    routeLayer.removeAll();
    ambulanceLayer.removeAll();
    animationHandles.forEach(cancelAnimationFrame);
    animationHandles = [];
  }

  async function startSimulation() {
    clearMap();

    const ambulances = [
      {
        id: "ambulance1",
        start: [10.1658324, 36.81898319],
        end: [10.1749917, 36.82097377],
        color: [0, 122, 255]
      },
      {
        id: "ambulance2",
        start: [10.1600, 36.8175],
        end: [10.1700, 36.8220],
        color: [52, 199, 89]
      }
    ];

    for (const amb of ambulances) {
      const res = await fetch("/api/gis/getRoute", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: { longitude: amb.start[0], latitude: amb.start[1] },
          end: { longitude: amb.end[0], latitude: amb.end[1] }
        })
      });

      const data = await res.json();
      if (!data?.route?.geometry?.paths?.[0]) continue;

      const path = data.route.geometry.paths[0];

      routeLayer.add(new Graphic({
        geometry: new Polyline({ paths: [path] }),
        symbol: { type: "simple-line", color: amb.color, width: 3 }
      }));

      const ambulanceGraphic = new Graphic({
        geometry: new Point({
          longitude: path[0][0],
          latitude: path[0][1]
        }),
        symbol: {
          type: "simple-marker",
          style: "square",
          size: 14,
          color: [255, 50, 50],
          outline: { color: "white", width: 2 }
        }
      });

      ambulanceLayer.add(ambulanceGraphic);

      animateAlongPath(amb.id, path, ambulanceGraphic);
    }
  }

  function animateAlongPath(id, path, graphic) {
    let segment = 0;
    let t = 0;

    function step() {
      if (segment >= path.length - 1) return;

      const [x1, y1] = path[segment];
      const [x2, y2] = path[segment + 1];

      t += 0.02;

      if (t >= 1) {
        t = 0;
        segment++;
      }

      const lon = x1 + (x2 - x1) * t;
      const lat = y1 + (y2 - y1) * t;

      graphic.geometry = new Point({ longitude: lon, latitude: lat });

      // ðŸ”´ Emit GeoJSON-compatible payload
      socket.emit("ambulanceLocationUpdate", {
        id,
        location: {
          type: "Point",
          coordinates: [lon, lat]
        }
      });

      const handle = requestAnimationFrame(step);
      animationHandles.push(handle);
    }

    step();
  }

  startBtn.onclick = startSimulation;
  stopBtn.onclick = clearMap;
  clearBtn.onclick = clearMap;
</script>

</body>

</html>